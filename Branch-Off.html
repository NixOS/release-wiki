<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Branch-off - NixOS Release Wiki</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Home.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded "><a href="Release-Management-Team.html"><strong aria-hidden="true">2.</strong> Release Management Team</a></li><li class="chapter-item expanded "><a href="Release-Critical-Packages.html"><strong aria-hidden="true">3.</strong> Release Critical Packages</a></li><li class="chapter-item expanded "><a href="Release-Process.html"><strong aria-hidden="true">4.</strong> Release Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Once-Appointed.html"><strong aria-hidden="true">4.1.</strong> What to do once appointed</a></li><li class="chapter-item expanded "><a href="Feature-Freeze-Announcement.html"><strong aria-hidden="true">4.2.</strong> Feature Freeze announcement and pre-release cleanup</a></li><li class="chapter-item expanded "><a href="Zero-Hydra-Failures.html"><strong aria-hidden="true">4.3.</strong> ZERO Hydra Failures</a></li><li class="chapter-item expanded "><a href="Branch-Off.html" class="active"><strong aria-hidden="true">4.4.</strong> Branch-off</a></li><li class="chapter-item expanded "><a href="Release-Process-Walkthrough.html"><strong aria-hidden="true">4.5.</strong> Release Process Walkthrough</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">NixOS Release Wiki</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#branch-off" id="branch-off">Branch-off</a></h1>
<p>For these steps &quot;21.05&quot; represents the current release tag and &quot;21.11&quot; represents the next
(6 months in the future) release tag. &quot;20.11&quot; is the last release which was released 6 months
ago.</p>
<h2><a class="header" href="#jobset-creation" id="jobset-creation">Jobset creation</a></h2>
<p>The <a href="https://matrix.to/#/#infra:nixos.org">infrastructure team</a> can create the necessary jobsets
in advance. They will not evaluate because the release branch doesn't exist but it allows the
infrastructure team and the release team to work more asynchronously. Reach out to them 1-2 days
before release to create the necessary Hydra Jobsets. You can link them this section.</p>
<ul>
<li><a href="https://hydra.nixos.org/project/nixos">https://hydra.nixos.org/project/nixos</a>
<ul>
<li>release-21.05	NixOS 21.05</li>
<li>release-21.05-aarch64	NixOS 21.05</li>
<li>release-21.05-small	NixOS 21.05</li>
</ul>
</li>
<li><a href="https://hydra.nixos.org/project/nixpkgs">https://hydra.nixos.org/project/nixpkgs</a>
<ul>
<li>nixpkgs-21.05-darwin</li>
<li>staging-next-21.05</li>
</ul>
</li>
</ul>
<p>For example: <a href="https://hydra.nixos.org/jobset/nixos/release-21.05#tabs-configuration">21.05 configuration</a></p>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>State</td><td>Enabled</td></tr>
<tr><td>Description</td><td>NixOS 21.05 release branch</td></tr>
<tr><td>Nix expression</td><td><code>nixos/release-combined.nix</code> in input <code>nixpkgs</code></td></tr>
<tr><td>Check interval</td><td>5000000</td></tr>
<tr><td>Scheduling shares</td><td>500</td></tr>
<tr><td>Number of evaluations to keep</td><td>1</td></tr>
</tbody></table>
<p>Inputs:</p>
<table><thead><tr><th>Input name</th><th>Type</th><th>Values</th></tr></thead><tbody>
<tr><td><code>nixpkgs</code></td><td>Git checkout</td><td><code>https://github.com/NixOS/nixpkgs.git release-21.05</code></td></tr>
<tr><td><code>stableBranch</code></td><td>Boolean</td><td><code>false</code></td></tr>
<tr><td><code>supportedSystems</code></td><td>Nix expression</td><td><code>[ &quot;x86_64-linux&quot; &quot;aarch64-linux&quot; ]</code></td></tr>
</tbody></table>
<h2><a class="header" href="#actual-branch-off" id="actual-branch-off">Actual branch-off</a></h2>
<ol>
<li>
<p>Wait for the staging team to merge the final staging-next iteration</p>
<pre><code class="language-shell">git fetch upstream staging-next
git merge upstream/staging-next
</code></pre>
</li>
<li>
<p>Fetch and check out the master branch</p>
</li>
<li>
<p>Update the <a href="https://github.com/NixOS/nixpkgs/blob/master/.github/workflows/periodic-merge-24h.yml">periodic-merge workflow</a> to include the new branch, then commit and push to master</p>
</li>
<li>
<p>Create the release branch:</p>
<pre><code class="language-shell">git switch -c release-21.05
</code></pre>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/commit/10e61bf5be57736035ec7a804cb0bf3d083bf2cf#diff-b3379a98640b35a5fe4b046150cd2df1639995edf231d18bbad832be6a70b45f">Bump the <code>system.defaultChannel</code> attribute in
<code>nixos/modules/misc/version.nix</code></a></p>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/commit/10e61bf5be57736035ec7a804cb0bf3d083bf2cf#diff-20da30ee012d7d87842fb7953237870493c5497c995cba1e6f6c3aa9268398ff">Update <code>versionSuffix</code> in
<code>nixos/release.nix</code></a></p>
<p>To get the commit count, use the following command:</p>
<pre><code class="language-shell">git rev-list --count release-21.05
</code></pre>
</li>
<li>
<p>Commit the changes from the previous steps</p>
</li>
<li>
<p>Create the staging branches</p>
<pre><code class="language-shell">git branch staging-21.05
git branch staging-next-21.05
</code></pre>
</li>
<li>
<p>Tag the release and push everything</p>
<pre><code class="language-shell">git tag --annotate --message=&quot;Release 21.05-beta&quot; 21.05-beta
git push upstream master release-21.05 21.05-beta staging-21.05 staging-next-21.05
</code></pre>
</li>
<li>
<p>Switch back to the master branch and <a href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-2bc0e46110b507d6d5a344264ef15adaR1">increment the <code>.version</code>
file</a></p>
<pre><code class="language-sh">git switch master
echo -n &quot;21.11&quot; &gt; .version
</code></pre>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-03f3d41b68f62079c55001f1a1c55c1dR137">Update <code>codeName</code> in
<code>lib/trivial.nix</code></a>
This will be the name for the next release.</p>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-e7ee5ff686cdcc513ca089d6e5682587R11">Create a new release notes file for the upcoming release +
1</a>,
in our case this is <code>rl-2111.section.md</code>. Don't forget to link the new file in the parent markdown file and to run <code>md-to-db.sh</code></p>
</li>
<li>
<p>Commit the changes (<a href="https://github.com/NixOS/nixpkgs/commit/bfdfe12c788d7474b88e7a7790b88b1c0f8e01b5">22.05 example</a>)</p>
</li>
<li>
<p>Tag master branch so that <code>git describe</code> shows the correct metadata.</p>
<pre><code class="language-shell">git tag --annotate 21.11-pre
git push upstream master 21.11-pre
git describe HEAD # should yield 21.11-pre
</code></pre>
</li>
<li>
<p>Trigger an evaluation of the new jobsets in Hydra</p>
</li>
<li>
<p>Create a channel at <code>https://nixos.org/channels</code> by creating a PR to
<code>nixos-org-configurations</code>. Update <a href="https://github.com/NixOS/nixos-org-configurations/blob/master/channels.nix"><code>channels.nix</code></a> to include the channel as a beta channel and notify the infrastructure team. <a href="https://github.com/NixOS/nixos-org-configurations/pull/209">22.05 example</a></p>
</li>
<li>
<p>Create the backport <a href="https://github.com/NixOS/nixpkgs/labels">labels</a> for all new branches:</p>
<ul>
<li><code>backport staging-21.05</code></li>
<li><code>backport staging-21.05</code></li>
</ul>
<p>Use the description <code>Backport PR automatically</code> and the color value <code>#0fafaa</code></p>
</li>
<li>
<p>Update the flake input of nixos-search once the Pull Request in <code>nixos-org-configurations</code> is merged:</p>
<ul>
<li>Clone <a href="https://github.com/NixOS/nixos-search">nixos-search</a></li>
<li>Update the flake inputs:
<pre><code class="language-shell">nix --extra-experimental-features nix-command\ flakes flake update
</code></pre>
</li>
<li>Commit the result and create a Pull Request</li>
</ul>
</li>
<li>
<p>Inform the <a href="https://matrix.to/#/#marketing:nixos.org">Marketing team</a> about the upcoming release and the <code>nixos-serach</code> Pull Request</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="Zero-Hydra-Failures.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="Release-Process-Walkthrough.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="Zero-Hydra-Failures.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="Release-Process-Walkthrough.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
