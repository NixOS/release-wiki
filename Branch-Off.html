<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Branch-off - NixOS Release Wiki</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Home.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded "><a href="Roles.html"><strong aria-hidden="true">2.</strong> Roles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Release-Managers.html"><strong aria-hidden="true">2.1.</strong> Release Managers</a></li><li class="chapter-item expanded "><a href="Release-Editors.html"><strong aria-hidden="true">2.2.</strong> Release Editors</a></li></ol></li><li class="chapter-item expanded "><a href="Release-Critical-Packages.html"><strong aria-hidden="true">3.</strong> Release Critical Packages</a></li><li class="chapter-item expanded "><a href="Release-Process.html"><strong aria-hidden="true">4.</strong> Release Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Once-Appointed.html"><strong aria-hidden="true">4.1.</strong> What to do once appointed</a></li><li class="chapter-item expanded "><a href="Feature-Freeze-Announcement.html"><strong aria-hidden="true">4.2.</strong> Feature Freeze announcement and pre-release cleanup</a></li><li class="chapter-item expanded "><a href="Zero-Hydra-Failures.html"><strong aria-hidden="true">4.3.</strong> ZERO Hydra Failures</a></li><li class="chapter-item expanded "><a href="Branch-Off.html" class="active"><strong aria-hidden="true">4.4.</strong> Branch-off</a></li><li class="chapter-item expanded "><a href="Beta-Phase.html"><strong aria-hidden="true">4.5.</strong> Beta Phase</a></li><li class="chapter-item expanded "><a href="Final-Release.html"><strong aria-hidden="true">4.6.</strong> Final Release</a></li><li class="chapter-item expanded "><a href="Retrospective.html"><strong aria-hidden="true">4.7.</strong> Retrospective</a></li><li class="chapter-item expanded "><a href="EOL-Cleanup.html"><strong aria-hidden="true">4.8.</strong> EOL cleanup</a></li><li class="chapter-item expanded "><a href="Handover.html"><strong aria-hidden="true">4.9.</strong> Handover to the next team</a></li></ol></li><li class="chapter-item expanded "><a href="Contrib.html"><strong aria-hidden="true">5.</strong> Contrib</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="QEMU-aarch64.html"><strong aria-hidden="true">5.1.</strong> QEMU Aarch64 Emulation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NixOS Release Wiki</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="branch-off"><a class="header" href="#branch-off">Branch-off</a></h1>
<p>For these steps &quot;24.05&quot; represents the current release tag and &quot;24.11&quot; represents the next
(6 months in the future) release tag. &quot;23.11&quot; is the last release which was released 6 months
ago.</p>
<h2 id="jobset-creation"><a class="header" href="#jobset-creation">Jobset creation</a></h2>
<p>The <a href="https://matrix.to/#/#infra:nixos.org">infrastructure team</a> can create the necessary jobsets
in advance. They will not evaluate because the release branch doesn't exist but it allows the
infrastructure team and the release team to work more asynchronously. Reach out to them 1-2 days
before release to create the necessary Hydra Jobsets. You can link them this section.</p>
<ul>
<li><a href="https://hydra.nixos.org/project/nixos">https://hydra.nixos.org/project/nixos</a>
<ul>
<li>release-24.05</li>
<li>release-24.05-small</li>
</ul>
</li>
<li><a href="https://hydra.nixos.org/project/nixpkgs">https://hydra.nixos.org/project/nixpkgs</a>
<ul>
<li>nixpkgs-24.05-darwin</li>
<li>staging-next-24.05</li>
</ul>
</li>
</ul>
<p>Example configuration: <a href="https://hydra.nixos.org/jobset/nixos/release-23.11#tabs-configuration">nixos:release-23.11</a></p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>State</td><td>Enabled</td></tr>
<tr><td>Description</td><td>NixOS 24.05 release branch</td></tr>
<tr><td>Nix expression</td><td><code>nixos/release-combined.nix</code> in input <code>nixpkgs</code></td></tr>
<tr><td>Check interval</td><td>86400</td></tr>
<tr><td>Scheduling shares</td><td>5000000 (8.32% out of 60071636 shares)</td></tr>
<tr><td>Enable Dynamic RunCommand Hooks:</td><td>No (not enabled by server)</td></tr>
<tr><td>Number of evaluations to keep</td><td>1</td></tr>
</tbody></table>
</div>
<p>Inputs:</p>
<div class="table-wrapper"><table><thead><tr><th>Input name</th><th>Type</th><th>Values</th></tr></thead><tbody>
<tr><td><code>nixpkgs</code></td><td>Git checkout</td><td><code>https://github.com/NixOS/nixpkgs.git release-24.05</code></td></tr>
<tr><td><code>stableBranch</code></td><td>Boolean</td><td><code>false</code></td></tr>
<tr><td><code>supportedSystems</code></td><td>Nix expression</td><td><code>[ &quot;x86_64-linux&quot; &quot;aarch64-linux&quot; ]</code></td></tr>
</tbody></table>
</div>
<h2 id="actual-branch-off"><a class="header" href="#actual-branch-off">Actual branch-off</a></h2>
<p>Set NEWVER to the new release version:</p>
<pre><code class="language-bash">export NEWVER=24.05
</code></pre>
<h3 id="on-the-master-branch"><a class="header" href="#on-the-master-branch">On the master branch</a></h3>
<p>Pull in the final changes before performing the actual branch-off.</p>
<ol>
<li>
<p>Wait for the staging team to merge the final staging-next iteration</p>
</li>
<li>
<p>Fetch and check out the master branch</p>
</li>
<li>
<p>Create the release branch:</p>
<pre><code class="language-bash">git switch -c release-$NEWVER
</code></pre>
</li>
</ol>
<h3 id="on-the-release-branch"><a class="header" href="#on-the-release-branch">On the release branch</a></h3>
<p>Update metadata on the release branch, create its staging branches and tag the release.</p>
<ol>
<li>
<p>Update the <code>system.defaultChannel</code> attribute in <a href="https://github.com/NixOS/nixpkgs/commit/bb029673bface2fc9fb807f209f63ca06478a72d"><code>nixos/modules/config/nix-channel.nix</code></a></p>
</li>
<li>
<p>Update the <code>versionSuffix</code> attribute in <a href="https://github.com/NixOS/nixpkgs/commit/7ae60dd7068478db5d936a3850b6df859aec21d0"><code>nixos/release.nix</code></a></p>
<p>To get the commit count, use the following command:</p>
<pre><code class="language-bash">git rev-list --count release-$NEWVER
</code></pre>
</li>
<li>
<p>Add <code>SUPPORT_END=YYYY-MM-DD</code> to <code>osReleaseContents</code> in <code>nixos/modules/misc/version.nix</code>.</p>
</li>
<li>
<p>Commit the changes from the previous steps</p>
<pre><code class="language-bash">git commit -m &quot;$NEWVER beta release&quot; -S
</code></pre>
</li>
<li>
<p>Create the staging branches</p>
<pre><code class="language-bash">git branch staging-$NEWVER
git branch staging-next-$NEWVER
</code></pre>
</li>
<li>
<p>Tag the release and push everything</p>
<pre><code class="language-bash">git tag --annotate --message=&quot;Release $NEWVER-beta&quot; $NEWVER-beta
git push upstream master release-$NEWVER $NEWVER-beta staging-$NEWVER staging-next-$NEWVER
</code></pre>
</li>
<li>
<p>Create jobsets on hydra by contacting the infrastructure team and start the evaluation on all new jobsets.</p>
</li>
<li>
<p>Switch back to the master branch</p>
<pre><code class="language-bash">git switch master
</code></pre>
</li>
</ol>
<h3 id="back-on-the-master-branch"><a class="header" href="#back-on-the-master-branch">Back on the master branch</a></h3>
<p>Now we prepare the master branch for the next release after this one.</p>
<ol>
<li>
<p>Update the <a href="https://github.com/NixOS/nixpkgs/blob/master/.github/workflows/periodic-merge-24h.yml">periodic-merge workflow</a> to include the new release.</p>
</li>
<li>
<p>Increment the <a href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-2bc0e46110b507d6d5a344264ef15adaR1"><code>.version</code></a>
file in the repository root.</p>
<pre><code class="language-bash"># The release after $NEWVER (24.05 -&gt; 24.11)
echo -n &quot;24.11&quot; &gt; .version
</code></pre>
</li>
<li>
<p>Update the <code>codeName</code> attribute in <a href="https://github.com/NixOS/nixpkgs/commit/2c28f1de7cdc10be556d2106108411dd2482794b#diff-29c71aa8261b14b1cad6e6fa28486fed7295050db4eeb32ba205672ba91d40e1"><code>lib/trivial.nix</code></a>
This will be the name for the next release.</p>
</li>
<li>
<p>Create a new <a href="https://github.com/NixOS/nixpkgs/blob/44b98d80ea6a56ccc1838aa0ac9e891de9130913/nixos/doc/manual/release-notes/rl-2311.section.md?plain=1">release notes file</a>
for the next release</p>
</li>
<li>
<p>Update the release versions in <a href="https://github.com/NixOS/nixpkgs/commit/2c6ae7132ca558f1052da0eececed3cad191b883#diff-18813c86948efc57e661623d7ba48ff94325c9b5421ec9177f724922dd553a35"><code>.github/PULL_REQUEST_TEMPLATE.md</code></a>
on master.</p>
</li>
<li>
<p>Update <a href="https://github.com/NixOS/nixpkgs/commit/2c6ae7132ca558f1052da0eececed3cad191b883#diff-eca12c0a30e25b4b46522ebf89465a03ba72a03f540796c979137931d8f92055"><code>CONTRIBUTING.md</code></a> on master.</p>
</li>
<li>
<p>Commit the changes (<a href="https://github.com/NixOS/nixpkgs/commit/2c28f1de7cdc10be556d2106108411dd2482794b">23.05 example</a> + <a href="https://github.com/NixOS/nixpkgs/commit/44b98d80ea6a56ccc1838aa0ac9e891de9130913">this commit</a> + <a href="https://github.com/NixOS/nixpkgs/commit/2c6ae7132ca558f1052da0eececed3cad191b883">this commit</a>)</p>
</li>
<li>
<p>Tag the master branch, so that <code>git describe</code> shows the new version as the base for commits.</p>
<pre><code class="language-bash">git tag --annotate 24.11-pre
git push upstream master 24.11-pre
git describe HEAD # should yield 24.11-pre
</code></pre>
</li>
</ol>
<h3 id="and-afterwards"><a class="header" href="#and-afterwards">And afterwards</a></h3>
<p>Now that everything on git is done, we are still missing the channels.</p>
<ol>
<li>
<p>Create the necessary channels for <code>https://channels.nixos.org</code> in beta status, by updating
<a href="https://github.com/NixOS/infra/blob/master/channels.nix"><code>channels.nix</code></a> in <code>infra</code>
and nag the infrastructure team to get these changes deployed.</p>
<p>Example: <a href="https://github.com/NixOS/infra/commit/9a0b3674a11b445c973334c78e8ca0eda36775e4">22.11</a></p>
</li>
<li>
<p>Create the backport <a href="https://github.com/NixOS/nixpkgs/labels">labels</a> for all new branches:</p>
<ul>
<li><code>backport staging-24.05</code></li>
<li><code>backport release-24.05</code></li>
</ul>
<p>Use the description <code>Backport PR automatically</code> and the color value <code>#0fafaa</code></p>
</li>
<li>
<p>Update the ZHF issue, that now that the branch-off has been performed, fixes have to be backported.
Examples: <a href="https://github.com/NixOS/nixpkgs/issues/172160#issuecomment-1135112918">22.05</a></p>
</li>
</ol>
<h3 id="once-the-channel-is-available"><a class="header" href="#once-the-channel-is-available">Once the channel is available</a></h3>
<p>The following steps should be done after the channels have become available on <a href="https://channels.nixos.org">channels.nixos.org</a>.</p>
<ol>
<li>
<p>Update the flake input on the <code>nixos-search</code> repository, and create a pull request:</p>
<pre><code class="language-bash">git clone git@github.com:nixos/nixos-search
nix --extra-experimental-features &quot;nix-command flakes&quot; flake lock --update-input nixos-infra
</code></pre>
</li>
<li>
<p>Give the <a href="https://matrix.to/#/#marketing:nixos.org">Marketing team</a> a heads-up about the upcoming release</p>
</li>
<li>
<p>Get in contact with <a href="https://github.com/arianvp">Arian van Putten</a></p>
<ol>
<li>They will need to update <a href="https://github.com/NixOS/amis/blob/main/.github/workflows/upload-legacy-ami.yml">upload-legacy-ami.yml</a> to point to the new jobset. This will automatically upload the AMIs from the jobset to AWS</li>
<li>A PR is also welcome :)</li>
</ol>
</li>
<li>
<p>Make sure the release editors have started finalizing the release notes. Only 7 days left until release!</p>
</li>
</ol>
<h2 id="for-release-editors"><a class="header" href="#for-release-editors">For Release Editors</a></h2>
<p>Following a branch-off, Release Editors should keep in mind that the release notes between <code>master</code>
and the release branches may fall out of sync. This is usually due to PRs adding release note
entries being merged post branch-off. Entries for changes not actually present in the branched
release may appear in <code>master</code> due to this, and backporting restructuring of the notes can be
troublesome.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Zero-Hydra-Failures.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="Beta-Phase.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Zero-Hydra-Failures.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="Beta-Phase.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
