# Final Release

## Before the final release

- Two days before expected release date, change `stableBranch` to `true` in Hydra and wait for the channel to update

- Re-check that the release notes are complete

- Merge the Pull Request that marks broken packages as broken

- [Update README.md with new stable NixOS version information.](https://github.com/NixOS/nixpkgs/commit/40fd9ae3ac8048758abdcfc7d28a78b5f22fe97e) (for `master` then backport to the release branch)

- Ensure the following items are sufficiently tested:
  - Graphical NixOS installer images (Can be found on nixos hydra jobset)
  - Minimal NixOS installer images (Can be found on nixos hydra jobset)

- Gather some information about the release for the final announcement

  - Number of commits for the release:

    ```shell
    git log upstream/release-20.11..upstream/release-21.05 --format=%an | wc -l
    ```

  - Commits by contributor:

    ```shell
    git shortlog --summary --numbered release-20.11..release-21.05
    ```

  - New/updated/removed packages:

    ```python
    #!/usr/bin/env bash

    import json

    # Files generated by checking out the corresponding branch and running:
    # NIX_PATH= nix-env -f $PWD -qaP --json --out-path > new.json
    with open('old.json') as f:
        old = json.load(f)
    with open('new.json') as f:
        new = json.load(f)

    n_removed = 0
    n_new = 0
    n_updated = 0
    for pkgname,pkg in new.items():
        if pkgname not in old:
            n_new += 1
            continue
        if pkg["version"] != old[pkgname]["version"]:
            n_updated += 1
    for pkgname in old.keys():
        if pkgname not in new:
            n_removed += 1

    print(f"New: {n_new}")
    print(f"Rem: {n_removed}")
    print(f"Upd: {n_updated}")
    ```

    Best to check how the previous announcement post was formulated to see what needs to
    be included.

  - Added/removed modules:

    ```shell
    git diff release-20.11..release-21.05 nixos/modules/module-list.nix | grep ^+ | wc -l
    git diff release-20.11..release-21.05 nixos/modules/module-list.nix | grep ^- | wc -l
    ```

  - Added/removed options:

    Download the result of the `nixos.options` job in Hydra from both your release and the previous release, then do:

    ```shell
    # removed options:
    comm -23 <(jq -r 'keys[]' old.json | sort) <(jq -r 'keys[]' new.json | sort) | wc -l
    # new options:
    comm -13 <(jq -r 'keys[]' old.json | sort) <(jq -r 'keys[]' new.json | sort) | wc -l
    ```

## At final release time

1. Create these PRs on master and backport to release-21.05:

   1. Update [Upgrading NixOS](https://nixos.org/manual/nixos/stable/index.html#sec-upgrading) section of the manual to match new
      stable release version.

   1. Update `rl-2105.xml` with the release date.

   1. Tag the final release

   1. Update the Pull Request Template and CONTRIBUTUTING.md on master ([21.11 example](https://github.com/NixOS/nixpkgs/pull/147977))

      ```shell
      git tag --annotate --message="Release 22.01" 21.05
      git push upstream 21.05
      ```

1. Update [nixos-homepage](https://github.com/NixOS/nixos-homepage) for
   the release ([22.05 example](https://github.com/NixOS/nixos-homepage/pull/853)).

   1. [Update the `flake.nix` input `released-nixpkgs` to 21.05](https://github.com/NixOS/nixos-homepage/blob/47ac3571c4d71e841fd4e6c6e1872e762b9c4942/flake.nix#L10).

   1. Run `./scripts/update.sh` (this updates flake.lock to updated channel).

   1. Add a compressed version of the NixOS logo ([19.09 example](https://github.com/NixOS/nixos-homepage/blob/a5626c71c03a2dd69086564e56f1a230a2bb177a/logo/nixos-logo-19.09-loris-lores.png)). The logo should have a width of 100px.

1. Update [nixos-org-configurations](https://github.com/NixOS/nixos-org-configurations) with the updated channel status ([21.11 example](https://github.com/NixOS/nixos-org-configurations/pull/192/files))
   - previous stable branches should be marked "deprecated"
   - beta branches should be marked "stable"

1. Create a new topic on [Discourse](https://discourse.nixos.org/) to announce the release

1. When the Pull Request in `nixos-org-configurations` is merged, update [nixos-search](https://github.com/NixOS/nixos-search/) to mark the channel as released.
   This is the same process as for the creation of the beta channel in the project.
